<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>公棚基本信息</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/my_style.css">
    <link rel="stylesheet" href="../css/datepicker.css">
    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/ajaxfileupload.js"></script>
    <script src="../js/public.js"></script>
    <script src="../js/moment.min.js"></script>
    <script src="../js/datepicker.all.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=McNGNstqGgRVbESkMBUmfciFxnsWpQ0g"></script>
    <style>
        input[type=date]::-webkit-inner-spin-button {
            visibility: hidden;
        }
        
        .address {
            width: 240px;
            line-height: 30px;
            margin-left: 20px;
            padding: 0 20px;
            border: 1px solid #eee;
        }
        
        .J-datepicker {
            position: relative;
            height: 32px;
            background: #fff;
            top: 20px;
        }
        
        .J-datepicker i {
            position: absolute;
            width: 19px;
            height: 19px;
            top: 50%;
            right: 10px;
            background: url(../image/time.png) no-repeat;
            margin-top: -9.5px;
        }
        
        .J-datepicker input {
            position: relative !important;
            top: -20px;
            z-index: 2;
            padding-right: 20px;
            background: rgba(0, 0, 0, 0);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div>
        <div class="commod_tit" id="order_tit">
            <span>公棚详情</span>
        </div>
        <div class="commodity_box">
            <div class="business_infor">
                <ol class="clearfix">
                    <li class="clearfix">
                        <span>公棚ID</span>
                        <span id="oneloftId_dom">12399007788</span>
                    </li>
                    <li>
                        <span>注册日期</span>
                        <span id="createTime">2018-7-09 18:34</span>
                    </li>
                    <li>
                        <span>最后登录日期</span>
                        <span id="loginTime">2018-09-09 18:23</span>
                    </li>
                </ol>
                <ul class="clearfix">
                    <li>
                        <span>公棚名称</span>
                        <div>
                            <input type="text" placeholder="" id="oneloftName">
                        </div>
                    </li>
                    <li>
                        <span>类型</span>
                        <div class="business_infor_xz" id="oneloftType">
                            <p class="">
                                <label for="spring">
                                    <input id="spring" type="radio" name="lostType">
                                    <span>春棚</span>
                                </label>
                            </p>
                            <p class="">
                                <label for="autumn">
                                    <input id="autumn" type="radio" name="lostType">
                                    <span>秋棚</span>
                                </label>
                            </p>
                        </div>
                    </li>
                    <li>
                        <span>成立日期</span>
                        <div class="J-datepicker">
                            <i class=""></i>
                            <input type="text" autocomplete="off" name="" placeholder="选择日期" id="buildTime" readonly="readonly">
                        </div>
                    </li>
                </ul>
            </div>
            <div class="business_infor_location">
                <h3>位置<input type="text" class="address" id="address"></h3>
                <div id="container" style="width:100%; height:300px"></div>
            </div>
            <div class="input_info_phone">
                <span>联系电话</span>
                <input type="text" placeholder="13822223333" id="mobile">
            </div>
            <div class="input_info_cont clearfix">

                <div class="input_info_list">
                    <p><span>形象展示</span>添加视频或者图片</p>
                    <ul class="loft_img_box clearfix" id="oneloftShow">
                        <li>
                            <div class="up_box">
                                <img src="../image/load2.gif" id="videoLoading" style="display:none;">
                                <video src="" id="small_video"></video>
                                <input type="file" name="upfile" multiple="multiple" class="upVideo" id="pigeon_video" accept="video/*" />
                                <b class="look_video">上传视频</b>
                            </div>
                            <em class="del_img"></em>
                        </li>
                        <li>
                            <div class="up_box j_up_img">
                                <img src="" alt="">
                                <input type="file" name="upfile" class="upImg" id="up_img1" accept="image/*" />
                                <i>上传图片</i>
                            </div>
                            <em class="del_img"></em>
                        </li>
                        <li>
                            <div class="up_box j_up_img">
                                <img src="" alt="">
                                <input type="file" name="upfile" class="upImg" id="up_img2" accept="image/*" />
                                <i>上传图片</i>
                            </div>
                            <em class="del_img"></em>
                        </li>
                        <li>
                            <div class="up_box j_up_img">
                                <img src="" alt="">
                                <input type="file" name="upfile" class="upImg" id="up_img3" accept="image/*" />
                                <i>上传图片</i>
                            </div>
                            <em class="del_img"></em>
                        </li>
                        <li>
                            <div class="up_box j_up_img">
                                <img src="" alt="">
                                <input type="file" name="upfile" class="upImg" id="up_img4" accept="image/*" />
                                <i>上传图片</i>
                            </div>
                            <em class="del_img"></em>
                        </li>
                    </ul>
                </div>

                <div class="input_info_chose">
                    <h3 class="clearfix">
                        <span>公棚logo</span>
                        <span id="no_logo">未选择文件</span>
                        <div class="oneloft_logo">
                            <img src="" id="logo_img" />
                        </div>

                    </h3>
                    <div class="input_info_btn">
                        <input type="file" name="upfile" id="uploadLogo" accept="image/*"> 选择文件
                    </div>
                </div>
            </div>
            <div class="editor_button" style="padding-top:30px;">
                <button id="return_btn">返回</button>
                <button id="save_btn">保存</button>
            </div>
        </div>
    </div>
    <!--视频放大-->
    <div id="video" class="video_box">
        <div>
            <video id="big_video" controls="controls"></video>
        </div>
    </div>
    <!--缩略图放大-->
    <div class="pay_big_img_box" style="display:none">
        <div>
            <img src="../image/cp.png" />
        </div>
    </div>
    <script src="../js/date.js "></script>
    <script>
        // 百度地图API功能
        var oneloftId = getParameter("oneloftId");
        var city = $("#address").val() || "北京";
        var map = new BMap.Map("container");
        var locationStr = "";
        map.centerAndZoom(city, 12);
        map.enableScrollWheelZoom(); //启用滚轮放大缩小，默认禁用
        map.enableContinuousZoom(); //启用地图惯性拖拽，默认禁用   

        map.addControl(new BMap.NavigationControl()); //添加默认缩放平移控件
        map.addControl(new BMap.OverviewMapControl()); //添加默认缩略地图控件
        map.addControl(new BMap.OverviewMapControl({
            isOpen: true,
            anchor: BMAP_ANCHOR_BOTTOM_RIGHT
        })); //右下角，打开

        var localSearch = new BMap.LocalSearch(map);
        localSearch.enableAutoViewport(); //允许自动调节窗体大小
        //通过城市，查询经纬度
        function searchByStationName(addressDom) {
            map.clearOverlays(); //清空原来的标注
            var keyword = addressDom.val();
            localSearch.setSearchCompleteCallback(function(searchResult) {
                var poi = searchResult.getPoi(0);
                //addressDom.attr("location", locationStr);
                map.centerAndZoom(poi.point, 13);
                var marker = new BMap.Marker(new BMap.Point(poi.point.lng, poi.point.lat)); // 创建标注，为要查询的地方对应的经纬度
                map.addOverlay(marker);
                var content = addressDom.val() + "<br/><br/>经度：" + poi.point.lng + "<br/>纬度：" + poi.point.lat;
                var infoWindow = new BMap.InfoWindow("<p style='font-size:14px;'>" + content + "</p>");
                locationStr = poi.point.lng + " " + poi.point.lat;
                marker.addEventListener("click", function() {
                    this.openInfoWindow(infoWindow);
                });
                // marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
            });
            localSearch.search(keyword);
        }
        /* 
         *3、公棚详情接口
         *http://域名/oneloft/find
         */
        function initRequestPage() {
            $.ajax({
                url: location.origin + "/oneloft/find",
                type: "post",
                data: JSON.stringify({
                    "oneloftId": oneloftId
                }),
                dataType: "json",
                contentType: "application/json",
                success: function(data) {
                    //errorToken(data.code);
                    var oneloftObj = data.data;
                    //setInfo(oneloftObj);
                },
                error: function() {
                    myAlert.createBox("网络不给力")
                }
            });
        };

        function setInfo(oneloftObj) {
            $("#createTime").html(oneloftObj.createdTime || "-"); //创建时间
            $("#loginTime").html(oneloftObj.loginTime || "-"); //最后登录时间
            $("#oneloftName").val(oneloftObj.oneloftName || "-"); //公棚名称
            if (oneloftObj.logo) {
                $("#logo_img").attr("src", oneloftObj.logo);
                $("#logo_img").parent().show();
                $("#no_logo").hide();
            }
            $("#mobile").val(oneloftObj.mobile).prop("readonly", true); //手机号
            $("#oneloftType").find("input[type=radio]").eq(oneloftObj.oneloftType).prop("checked", true); //公棚类型 0 春棚 1秋棚

            $("#buildTime").val(oneloftObj.establishTime); //成立日期
            $("#address").attr("location", oneloftObj.location);
            $("#address").val(oneloftObj.address);
            var liStr = "";
            var oneloftShowObj = oneloftObj.oneloftShow;
            if (oneloftShowObj.images.length > 0) {
                oneloftShowObj.images.forEach(function(val, index) {
                    $("#oneloftShow li").eq(index + 1).find("img").attr("src", val.img);
                    $("#oneloftShow li").eq(index + 1).find("input").hide();
                    $("#oneloftShow li").eq(index + 1).find("em").show();
                    if (val.isCover && val.isCover == "Y") {
                        $("#oneloftShow li").eq(index + 1).find("i").html("设为封面").addClass("active");
                    } else {
                        $("#oneloftShow li").eq(index + 1).find("i").html("上传图片");
                    }
                })
            }
            if (oneloftShowObj.videos && oneloftShowObj.videos.length > 0) {
                var videoURL = oneloftShowObj.videos[0].video;
                $("#small_video").attr("src", videoURL);
                $("#big_video").attr("src", videoURL)
                $("#oneloftShow li").eq(0).find("b").html("查看视频");
                $("#oneloftShow li").eq(0).find(".del_img").show();
                $("#oneloftShow li").eq(0).find("input").hide();
            }
        };

        /**
         * 添加
         * 
         */
        function saveRequest(saveData) {
            $.ajax({
                url: location.origin + "/operator/oneloft/find",
                type: "post",
                data: JSON.stringify(saveData),
                dataType: "json",
                contentType: "application/json",
                success: function(data) {
                    errorToken(data.code);
                    myAlert.createBox("保存成功");
                },
                error: function() {
                    myAlert.createBox("网络不给力")
                }
            })
        };
        /**
         * 编辑
         * 50、公棚编辑接口
         */
        function editorRequest(editorData, callback) {
            $.ajax({
                url: location.origin + "/operator/oneloft/edit",
                type: "post",
                data: JSON.stringify(editorData),
                dataType: "json",
                contentType: "application/json",
                success: function(data) {
                    errorToken(data.code);
                    myAlert.createBox("保存成功");
                    callback && callback();
                },
                error: function() {
                    myAlert.createBox("网络不给力")
                }
            });
        }

        $(function() {
            //十分秒年月日单个
            $('.J-datepicker').datePicker({
                hasShortcut: true,
                min: '',
                max: '',
                shortcutOptions: [{
                    name: '今天',
                    day: '0'
                }, {
                    name: '昨天',
                    day: '-1',
                    time: '00:00:00'
                }, {
                    name: '一周前',
                    day: '-7'
                }],
                hide: function() {
                    console.info(this)
                }
            });
            $("#oneloftId_dom").html(oneloftId);
            initRequestPage();
            //输入地理位置
            $("#address").on("keyup", function() {
                var $this = $(this);
                searchByStationName($this);
            });

            //返回
            $("#return_btn").on("click", function() {
                window.history.go(-1);
            });
            //点击保存
            $("#save_btn").on("click", function() {
                if (!isAllInfo()) {
                    myAlert.createBox("信息填写不完整，请重新填写!");
                    return false;
                }
                var upImgObj = $("#oneloftShow").find(".j_up_img").find("img");
                var imgArr = [];
                upImgObj.each(function(index) {
                    var isCover = $(this).closest("li").attr("isCover");
                    var imgSrc = upImgObj.eq(index).attr("src");
                    if (imgSrc) {
                        imgArr.push({
                            "img": imgSrc, //name ?
                            "isCover": isCover, //1:设置封面，0：不设封面
                        });
                    }
                });
                var videoArr = [];
                if ($("#small_video").attr("src")) {
                    videoArr.push({
                        "video": $("#small_video").attr("src"),
                        "alt": "",
                        "desc": ""
                    })
                }
                var saveData = {
                    "address": city,
                    "cityCode": city,
                    "location": locationStr || $("#address").attr("location"),
                    "establishTime": $("#buildTime").val(),
                    "logo": $("#logo_img").attr("src"),
                    "oneloftDesc": "",
                    "oneloftId": $("#oneloftId_dom").html(),
                    "oneloftName": $("#oneloftName").val(),
                    "oneloftShow": {
                        "images": imgArr,
                        "videos": videoArr
                    },
                    "oneloftType": $("#oneloftType").find("input[type=radio]:checked").index(),
                    "provinceCode": "",
                    "realName": "",
                    "logo": $("#logo_img").attr("src")
                }
                alert(saveData.location)
                editorRequest(saveData, function() {
                    window.history.go(-1);
                });
            })

            /**
             * 橱窗
             */
            $("#oneloftShow").on("change", ".upImg", function() {
                var $this = $(this);
                var _index = $this.closest("li").index();
                var imgDom = $this.prev().get(0);
                var thisId = $(this).attr("id");
                var postUrl = location.origin + '/ueditor?action=uploadimage';
                sessionStorage.setItem("businessImgIndex", _index + "");
                if (!$this.val()) {
                    return;
                }
                imgDom.src = "../image/load2.gif";
                uploadRequest(postUrl, thisId, function(imgUrl) {
                    imgDom.src = imgUrl;
                    var _index = Number(sessionStorage.getItem("businessImgIndex"));
                    var iDom = $("#oneloftShow").find("li").eq(_index).find("i");
                    if (iDom.html() == "上传图片") {
                        iDom.html("设为封面");
                        $("#oneloftShow").find("li").eq(_index).find(".del_img").show();
                        $("#oneloftShow").find("li").eq(_index).find("input").hide();
                    }
                });
            });
            //点击 “设为封面”
            $("#oneloftShow li").on("click", "i", function() {
                if ($(this).html() == "设为封面") {
                    $("#oneloftShow i").removeClass("active");
                    $("#oneloftShow li").attr("isCover", "N");
                    $(this).addClass("active");
                    $(this).closest("li").attr("isCover", "Y"); //设为封面
                }
            });
            //选择上传视频
            $("#oneloftShow").on("change", ".upVideo", function() {
                var $this = $(this);
                var _index = 0;
                var input1 = $this.get(0);
                var thisId = $(this).attr("id");
                var postUrl = location.origin + "/ueditor?action=uploadvideo";
                $("#videoLoading").show();
                $("#small_video").hide();
                uploadRequest(postUrl, thisId, function(videoUrl) {
                    $("#videoLoading").hide();
                    $("#small_video").show();
                    $("#small_video").attr("src", videoUrl);
                    $("#big_video").attr("src", videoUrl);
                    $("#oneloftShow").find("li").eq(0).find("b").html("查看视频");
                    $("#oneloftShow").find("li").eq(0).find(".del_img").show();
                    $("#oneloftShow").find("li").eq(0).find("input").hide();
                });
            });
            //点击 “查看视频"
            $(".look_video, #small_video").on("click", function() {
                if ($(".look_video").html() == "查看视频") {
                    $("#video").show();
                }
            });
            //点击 “删除” 按钮
            $(".del_img").on("click", function() {
                $(this).closest("li").find("i").removeClass("active");
                $(this).closest("li").find("input[type=file]").val("");
                if ($(this).closest("li").index() == 0) {
                    $(this).closest("li").find("video").attr("src", "");
                    $(this).closest("li").find("b").html("上传视频");
                } else {
                    $(this).closest("li").find("img").attr("src", "");
                    $(this).closest("li").find("i").html("上传图片");
                }
                $(this).closest("li").find("input[type=file]").show();
                $(this).hide();
            });
            //点击 视频 遮罩 ,隐藏
            $("#video").on("click", function() {
                $(this).hide();
            });

            //点击上传 “logo”
            $("#uploadLogo").on("change", function() {
                var $this = $(this);
                var _index = $this.index();
                var input1 = $this.get(0);
                var imgDom = $("#logo_img").get(0);
                var thisId = "uploadLogo";
                var postUrl = location.origin + '/ueditor?action=uploadimage';
                uploadRequest(postUrl, thisId, function(imgUrl) {
                    $("#no_logo").hide();
                    $(".oneloft_logo").show();
                    imgDom.src = imgUrl;
                });
            });
        });
        //点击查看 原图
        $(".j_up_img img").on("click", function() {
            $(".pay_big_img_box img").attr("src", $(this).attr("src"));
            $(".pay_big_img_box").show();
        });
        //缩略图 关闭
        $(".pay_big_img_box").on("click", function() {
            $(this).hide();
        });
        $(".pay_big_img_box img").on("click", function(ev) {
            ev.stopPropagation();
        });
        //校验所有输入框
        function isInputText() {
            if (!$("#oneloftName").val()) {
                myAlert.createBox("请填写公棚名称！");
                return false;
            }
            if (!$("#buildTime").val()) {
                myAlert.createBox("请填写成立日期！");
                return false;
            }
            if (!$("#address").val()) {
                myAlert.createBox("请填写地址！");
                return false;
            }
            return true;
        }
        //校验图片选择
        function isInputFile() {
            var inputCheck = $("#oneloftShow li").find("img");
            for (var i = 0; i < inputCheck.length; i++) {
                if (inputCheck.eq(i).attr("src")) {
                    return true;
                }
            }
            return false;
        }
        //校验页面信息是否填写完整
        function isAllInfo() {
            if (!isInputText() || !isInputFile()) {
                return false;
            } else {
                return true;
            }
        }
    </script>
</body>

</html>