<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>编辑商品</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/m_style.css">
    <style>
        .input_info_tit{
            position: relative;
        }
        .iconfont{font-size: 11px;}
        .warn{text-align: left !important;font-size: 11px !important;left:170px;}
    </style>
    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/ajaxfileupload.js"></script>
    <script src="../js/public.js"></script>
    <script type="text/javascript" charset="utf-8" src="/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="/ueditor/ueditor.all.min.js">
    </script>
    <script type="text/javascript" charset="utf-8" src="/ueditor/lang/zh-cn/zh-cn.js"></script>
</head>

<body>
    <div>
        <div class="commod_tit" id="order_tit">
        </div>
        <div class="commodity_box product_info">
            <h5>编辑商品</h5>
            <div class="input_info_tit clearfix">
                <span>商家</span>
                <input type="text" placeholder="" id="businesName" readonly="readonly">
                <span class="warn"><i class="iconfont red icon-tixingshixin"></i>请填写商家名称</span>
            </div>
            <div class="input_info_tit clearfix">
                <span>商品名称</span>
                <input type="text" placeholder="请输入商品名称" id="pigeonName">
                <span class="warn">
                    <i class="iconfont red icon-tixingshixin"></i>请填写商品名称</span>
            </div>
            <div class="input_info_tit clearfix">
                <span>标签</span>
                <input type="text" placeholder="请输入标签" id="pigeonTab">
            </div>
            <div class="input_info_tit clearfix">
                <span>环号</span>
                <input type="text" placeholder="请输入环号" id="pigeonNo">
                <span class="warn">
                    <i class="iconfont red icon-tixingshixin"></i>请填写环号</span>
            </div>
            <div class="input_info_tit clearfix " id="pigeonGender">
                <span>性别</span>
                <label for="F">
                    <input type="radio" id="F" name="sex">
                    <i></i>
                    雌
                </label>
                <label for="M">
                    <input type="radio" id="M" name="sex">
                    <i></i>
                    雄
                </label>
            </div>
            <div class="input_info_tit clearfix">
                <span>羽色</span>
                <input type="text" placeholder="请输入羽色" id="pigeonFeather">
                <span class="warn">
                    <i class="iconfont red icon-tixingshixin"></i>请填写羽色</span>
            </div>
            <div class="input_info_tit clearfix">
                <span>眼砂</span>
                <input type="text" placeholder="请输入眼砂" id="pigeonEye">
            </div>
            <div class="input_info_tit clearfix">
                <span>血统</span>
                <input type="text" placeholder="请输入血统" id="pigeonBlood">
                <span class="warn">
                    <i class="iconfont red icon-tixingshixin"></i>请填写血统</span>
            </div>
            <div class="input_info_tit clearfix">
                <span>卖点</span>
                <input type="text" placeholder="请输入卖点" id="pigeonPoint">
                <span class="warn">
                    <i class="iconfont red icon-tixingshixin"></i>请填写卖点</span>
            </div>
            <div class="input_info_tit clearfix">
                <span>价格</span>
                <input type="text" placeholder="请输入价格" style="width:25%" id="pigeonPrice">
                <span style="color:#bbb;">单位：人民币（元）</span>
                <span class="warn">
                    <i class="iconfont red icon-tixingshixin"></i>请填写价格</span>
            </div>
            <div class="input_info_cont clearfix">
                <span>橱窗展示</span>
                <div class="input_info_list">
                    <p>添加视频或图片，仅支持gif、jpeg、png、bmp四种格式，大小不超过3.0MB</p>
                    <ul class="clearfix" id="pigeonShow">
                        <li>
                            <div class="up_box">
                                <img src="../image/load2.gif" id="videoLoading" style="display:none;">
                                <video src="" id="small_video"></video>
                                <input type="file" name="upfile" multiple="multiple" class="upVideo" id="pigeon_video" accept="video/*" />
                                <b class="look_video">上传视频</b>
                            </div>
                            <em class="del_img"></em>
                        </li>
                        <li>
                            <div class="up_box j_up_img">
                                <img src="" alt="">
                                <input type="file" name="upfile" class="upImg" id="up_img1" accept="image/*" />
                                <i>上传图片</i>
                            </div>
                            <em class="del_img"></em>
                        </li>
                        <li>
                            <div class="up_box j_up_img">
                                <img src="" alt="">
                                <input type="file" name="upfile" class="upImg" id="up_img2" accept="image/*" />
                                <i>上传图片</i>
                            </div>
                            <em class="del_img"></em>
                        </li>
                        <li>
                            <div class="up_box j_up_img">
                                <img src="" alt="">
                                <input type="file" name="upfile" class="upImg" id="up_img3" accept="image/*" />
                                <i>上传图片</i>
                            </div>
                            <em class="del_img"></em>
                        </li>
                        <li>
                            <div class="up_box j_up_img">
                                <img src="" alt="">
                                <input type="file" name="upfile" class="upImg" id="up_img4" accept="image/*" />
                                <i>上传图片</i>
                            </div>
                            <em class="del_img"></em>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="input_info_cont clearfix">
                <span>详细描述</span>
                <div class="editor_box" style="float:left; width:70%">
                    <script id="editor" type="text/plain" style="width:100%; height:300px"></script>
                </div>
            </div>
            <div class="editor_button">
                <button id="return_btn">返回</button>
                <button id="save_btn">保存</button>
            </div>
        </div>
    </div>
    <!--视频放大-->
    <div id="video" class="video_box">
        <div>
            <video id="big_video" controls="controls"></video>
        </div>
    </div>
    <!--缩略图放大-->
    <div class="pay_big_img_box" style="display:none">
        <div>
            <img src="../image/cp.png" />
        </div>
    </div>

    <script src="../js/product_editor.js"></script>
    <script>
        $(function() {
            if (pigeonId) { //编辑
                proEditorObj.editorRequst();
            } else {
                $("#businesName").val(shopName);
            }
            //点击 “返回”
            $("#return_btn").on("click", function() {
                window.history.go(-1);
            });

            //选择图片上传 
            $("#pigeonShow").on("change", ".upImg", function() {
                var $this = $(this);
                var _index = $this.closest("li").index();
                var imgDom = $this.prev().get(0);
                var thisId = $(this).attr("id");
                var postUrl = location.origin + '/ueditor?action=uploadimage';
                if (!$this.val()) {
                    return;
                }
                imgDom.src = "../image/load2.gif";
                sessionStorage.setItem("businessImgIndex", _index + "");
                uploadRequest(postUrl, thisId, function(imgUrl) {
                    imgDom.src = imgUrl;
                    var _index = Number(sessionStorage.getItem("businessImgIndex"));
                    if ($("#pigeonShow").find("li").eq(_index).find("i").html() == "上传图片") {
                        $("#pigeonShow").find("li").eq(_index).find("i").html("设为封面");
                        $("#pigeonShow").find("li").eq(_index).find(".del_img").show();
                        $("#pigeonShow").find("li").eq(_index).find("input").hide();
                    }
                });
            });
            //点击 “设为封面”
            $("#pigeonShow li").on("click", "i", function() {
                if ($(this).html() == "设为封面") {
                    $("#pigeonShow i").removeClass("active");
                    $("#pigeonShow li").attr("isCover", "N");
                    $(this).addClass("active");
                    $(this).closest("li").attr("isCover", "Y"); //设为封面
                }
            });
            //选择上传视频
            $("#pigeonShow").on("change", ".upVideo", function() {
                var $this = $(this);
                var _index = 0;
                var thisId = $(this).attr("id");
                var postUrl = location.origin + "/ueditor?action=uploadvideo";
                if (!$this.val()) {
                    return;
                }
                $("#videoLoading").show();
                $("#small_video").hide();
                uploadRequest(postUrl, thisId, function(videoUrl) {
                    $("#videoLoading").hide();
                    $("#small_video").show();
                    $("#small_video").attr("src", videoUrl);
                    $("#big_video").attr("src", videoUrl);
                    $("#pigeonShow li").eq(0).find("b").html("查看视频");
                    $("#pigeonShow li").eq(0).find(".del_img").show();
                    $("#pigeonShow").find("li").eq(0).find("input").hide();
                });
            });
            //点击 “查看视频"
            $(".look_video, #small_video").on("click", function() {
                if ($(".look_video").html() == "查看视频") {
                    $("#video").show();
                }
            });
            //点击 “删除” 按钮
            $(".del_img").on("click", function() {
                $(this).closest("li").find("input[type=file]").val("");
                $(this).closest("li").find("i").removeClass("active");
                if ($(this).closest("li").index() == 0) {
                    $(this).closest("li").find("video").attr("src", "");
                    $(this).closest("li").find("b").html("上传视频");
                } else {
                    $(this).closest("li").find("img").attr("src", "");
                    $(this).closest("li").find("i").html("上传图片");
                }
                $(this).closest("li").find("input[type=file]").show();
                $(this).hide();
            });
            //点击 视频 遮罩 ,隐藏
            $("#video").on("click", function() {
                $(this).hide();
            });
            //点击 “保存”
            $("#save_btn").on("click", function() {
                if (!proEditorObj.isAllInfo()) {
                    myAlert.createBox("信息填写不完整，请重新录入！");
                    return;
                }
                //当前日期
                var nowTime = getNow();
                //获取上传的图片
                var upImgObj = $("#pigeonShow").find(".j_up_img").find("img");
                var imgArr = [];
                upImgObj.each(function(index) {
                    var isCover = $(this).closest("li").attr("isCover");
                    var imgSrc = upImgObj.eq(index).attr("src");
                    if (imgSrc) {
                        imgArr.push({
                            "img": imgSrc, //name ?
                            "isCover": isCover, //1:设置封面，0：不设封面
                        });
                    }
                });
                var videoArr = [];
                if ($("#small_video").attr("src")) {
                    videoArr.push({
                        "video": $("#small_video").attr("src"),
                        "alt": "",
                        "desc": ""
                    })
                }
                var saveData = { // 入参缺少标签 字段
                    "businessId": businessId || "",
                    "createdTime": nowTime,
                    "pigeonBlood": $("#pigeonBlood").val(),
                    "pigeonDesc": ue.getContent(), //富文本
                    "pigeonEye": $("#pigeonEye").val(),
                    "pigeonFeather": $("#pigeonFeather").val(),
                    "pigeonGender": $("#pigeonGender").find("input:checked").attr("id"),
                    "pigeonId": pigeonId || "",
                    "pigeonName": $("#pigeonName").val(),
                    "pigeonNo": $("#pigeonNo").val(),
                    "pigeonPoint": $("#pigeonPoint").val(),
                    "pigeonPrice": $("#pigeonPrice").val(),
                    "pigeonShow": {
                        "images": imgArr,
                        "videos": videoArr
                    },
                    "pigeonTags": $("#pigeonTab").val(),
                    "stickyTime": "" //置顶时间: 毫秒值
                };
                if (!pigeonId) { //添加
                    proEditorObj.addRequst(saveData, function() {
                        window.history.go(-1);

                    });
                } else { //编辑 保存、
                    proEditorObj.saveRequst(saveData, function() {
                        window.history.go(-1);
                    });
                }
            });
            //点击查看 原图
            $(".j_up_img img").on("click", function() {
                $(".pay_big_img_box img").attr("src", $(this).attr("src"));
                $(".pay_big_img_box").show();
            });
            //缩略图 关闭
            $(".pay_big_img_box").on("click", function() {
                $(this).hide();
            });
            $(".pay_big_img_box img").on("click", function(ev) {
                ev.stopPropagation();
            });
        })
    </script>
</body>

</html>