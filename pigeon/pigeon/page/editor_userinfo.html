<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>完善个人资料</title>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,target-densitydpi=medium-dpi">
    <meta name="format-detection" content="telephone=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="stylesheet" href="../css/reset.css" />
    <link rel="stylesheet" href="../css/per_data.css" />
</head>

<body>
    <div class="per_data">
        <div class="per_data_name">
            <div>
                <img src="../image/data.png" id="headImg">
            </div>
            <span id="nickName">章鱼墨水</span>
        </div>
        <ul class="per_data_line">
            <li class="clearfix">
                <span>姓　　名</span>
                <input type="text" placeholder="请输入" id="name">
            </li>
            <li class="clearfix">
                <span>证件号码</span>
                <input type="text" placeholder="请输入" id="cardid">
            </li>
            <li class="clearfix">
                <span>生　　日</span>
                <input type="text" placeholder="请输入" id="birthday" readonly="true">
            </li>
            <li class="clearfix">
                <span>地　　区</span>
                <input type="text" placeholder="请输入" id="city">
            </li>
            <li class="clearfix">
                <span>手　　机</span>
                <input type="text" placeholder="请输入" id="mobile">
            </li>
        </ul>
        <div class="per_data_btn">
            <button type="button" id="submit">提交</button>
        </div>
    </div>
    <script type="text/javascript" src="../js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="../js/public.js"></script>
    <script type="text/javascript" src="../js/weixin_init.js"></script>
    <script>
        var openid = getParameter("openid"); //openid
        var Authorization = localStorage.getItem("Authorization") || "";
        //var WX_USERINFO = getParameter("WX_USERINFO"); //用户信息
        var custumerInfo = JSON.parse(sessionStorage.getItem("custumerInfo"));
        $("#nickName").html(custumerInfo.nickName); //昵称
        $("#headImg").html(custumerInfo.profilePhoto); //头像
        $("#name").val(custumerInfo.realName);
        $("#cardid").val(custumerInfo.idCard);
        $("#birthday").val(getDateToAge(custumerInfo.idCard));
        $("#city").val(custumerInfo.address);
        $("#mobile").val(custumerInfo.mobile);

        //姓名校验
        $("#name").on("blur", function() {
            var val = $(this).val();

            if (val != "") {
                var nameFlag = checkFn.applicantName(val, "#name");
                if (!nameFlag) {
                    myAlert.createBox("姓名格式有误，请重新填写！")
                    $(this).val("");
                }
            }
        })
        $("#name").on("keyup", function() {
                if (checkFn.applicantName($(this).val(), "#name")) {
                    isAllInfo()
                } else {
                    $("#submit").removeClass("active");
                }
            })
            //证件号校验
        $("#cardid").on("blur", function() {
            var that = $(this);
            var val = that.val();
            val = removeSpace(val).trim();
            if (val) {
                if (!validateUser(val)) {
                    myAlert.createBox("输入的身份证号有误，请重新填写！");
                    that.val("");
                } else {
                    that.val(val);
                    $("#birthday").val(getDateToAge(val));
                }
            }
        })
        $("#cardid").on("keyup", function() {
            if (validateUser($(this).val())) {
                isAllInfo()
            } else {
                $("#submit").removeClass("active");
            }
        })

        //地区校验 不含有特殊字符即可
        $("#city").on("blur", function() {
            var s = $(this).val();
            if (s.length >= 5) {
                if (!stripscript(s)) {
                    myAlert.createBox("不能含有特殊字符，请重新输入！");
                    $(this).val("");
                }
            } else {
                myAlert.createBox("输入的地区不能小于5个字符！");
                $(this).val("");
            }

        })
        $("#city").on("keyup", function() {
                if ($(this).val().length >= 5 && stripscript($(this).val())) {
                    isAllInfo()
                } else {
                    $("#submit").removeClass("active");
                }
            })
            //手机号校验
        $("#mobile").on("blur", function() {
            var val = $(this).val();
            if (val && !checkInputPhone(val)) {
                myAlert.createBox("手机号码输入有误，请重新输入");
                $(this).val("");
            }
        })
        $("#mobile").on("keyup", function() {
                if ($(this).val().length >= 11 && checkInputPhone($(this).val())) {
                    isAllInfo()
                } else {
                    $("#submit").removeClass("active");
                }
            })
            //所有信息都填写完成
        function isAllInfo() {
            if (!$("#name").val() || !$("#cardid").val() || !$("#birthday").val() || !$("#city").val() || !$("#mobile").val()) {
                $("#submit").removeClass("active");
            } else {
                $("#submit").addClass("active");
            }
        }

        /**
         * 调接口18 修改用户信息接口
         * 用户头像是否可以修改，如果可以修改，是否改成form表单提交方式
         */
        function toSubmit(infoData) {
            $.ajax({
                url: location.origin + "/customer/edit",
                type: "post",
                data: JSON.stringify(infoData),
                contentType: "application/json",
                headers: {
                    Authorization: Authorization
                },
                success: function(data) {

                    myAlert.createBox("提交成功");
                    setTimeout(function() {
                        window.history.go(-1);
                    }, 1500);
                },
                error: function(err) {
                    myAlert.createBox("网络不给力");
                }
            })
        }

        //提交
        $("#submit").on("click", function() {
            isAllInfo();
            if ($(this).hasClass("active")) {
                var infoData = { //入参
                    "address": $("#city").val(),
                    "idCard": $("#cardid").val(),
                    "mobile": $("#mobile").val(),
                    "nickName": $("#nickName").html(),
                    "profilePhoto": custumerInfo.profilePhoto || "",
                    "realName": $("#name").val(),
                    "userName": custumerInfo.userName || ""
                }
                reloadToken({
                    Authorization: Authorization
                }, {
                    openid: openid
                }, function() {
                    Authorization = localStorage.getItem("Authorization") || "";
                    toSubmit(infoData);
                })

            } else {
                return false;
            }
        });
    </script>
</body>

</html>